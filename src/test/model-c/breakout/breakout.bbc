MODE 5:HIMEM=&3000:*LOAD S.BRKOUT 3000
PROCpal:?&EE=&D1:?&FCFF=&D1:?&FCFD=&FB:?&FCFE=&FF

GCOL0,1:MOVE0,0:DRAW 1279,0:DRAW 1279,1023:DRAW 0,1023:DRAW 0,0

REM spritelist areas
L1%=&4000:L2%=&4800

BATX%=160-8:SB%=0
Z%=0:L%=128:R%=L%+320-16-1:T%=32:B%=T%+256-16-1
X%=200:SX%=1:Y%=200:SY%=1
*FX19
REPEAT
Z%=(Z%+&80)AND&3FF
X%=X%+SX%:IF X%>R% OR X%<=L%THENSX%=-SX%
Y%=Y%+SY%:IF Y%>B% OR Y%<=T%THENSY%=-SY%
NB%=((&10000-ADVAL(1))/163)-40:IF NB%<0 THEN NB%=0 ELSE IF NB%>320-16 THEN NB%=320-16
SB%=(NB%-BATX%)/2:IF SB%>20 THEN SB%=20 ELSE IF SB%<-20 THEN SB%=-20
BATX%=BATX%+SB%
PROCupdate_sprites
*FX19
UNTIL0


END

REM the ball needs two overlapping sprites, use whole of channels 0,1 for that purpose for now
DEFPROCupdate_sprites:LOCALT%
PROCctldata(L1%,X%,Y%,16,TRUE,FALSE,FALSE,&3060+Z%)
PROCctldata(L1%+8,X%,Y%,16,FALSE,FALSE,FALSE,&30A0+Z%)
PROCctldata(L1%+16,L%+BATX%,B%-40,8,FALSE,FALSE,FALSE,&3020)
PROCctldata(L1%+24,L%+BATX%+16,B%-40,8,FALSE,FALSE,FALSE,&3040)
REM swap list pointers
!&FD0C=L1%:!&FD1C=L1%+8:!&FD2C=L1%+16:!&FD3C=L1%+24
T%=L1%:L1%=L2%:L2%=T%
ENDPROC


REM P = addr, X,Y,H - position/height A%=attach, D%=load data pointer next, C%=continue
DEFPROCctl(P%,X%,Y%,H%,A%,D%,C%):?P%=X%:P%?1=Y%:P%?2=Y%+H%:P%?3=((X%>255)AND1)OR((Y%>255)AND2)OR(((Y%+H%)>255)AND4)OR(A%AND128)OR(D%AND64)OR(C%AND32):ENDPROC
DEFPROCctldata(P%,X%,Y%,H%,A%,D%,C%,S%):?P%=X%:P%?1=Y%:P%?2=Y%+H%:P%?3=((X%>255)AND1)OR((Y%>255)AND2)OR(((Y%+H%)>255)AND4)OR(A%AND128)OR(D%AND64)OR(C%AND32):P%!4=S%:ENDPROC

 900DEFPROCpal:LOCALI,X:FORI=0TO15:READX%:?&FE23=X%DIV256:?&FE23=X%:NEXT:ENDPROC
1000DATA&0000,&1333,&2777,&3FF0,&400F,&5F0F,&60FF,&7FFF,&8502,&9E95,&A158,&BCC9,&CF80,&DAD3,&E99E,&FFFF
